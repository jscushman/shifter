<h3><%= @calendar.title %></h3>

<p>
  <%= @calendar.description %>
</p>

<ul>
  <li>Number of simultaneous reservations permitted: <%= @calendar.max_simultaneous %></li>
<% if @calendar.start_end_day? && @calendar.start_end_day > -1 %>
  <li>Reservations must start and end on <%= Date::DAYNAMES[@calendar.start_end_day] %></li>
<% else %>
  <li>Reservations can be begin and end on any day of the week</li>
<% end %>
  <li>Reservations must be at least <%= @calendar.min_days %> days</li>
</ul>

<% if admin? %>
  <p><%= link_to 'Edit calendar details', edit_calendar_path(@calendar), class: "btn btn-primary" %></p>
<% end %>

<h3>Reservations</h3>
<div class="pull-left">
  <%= link_to "New Reservation", new_appointment_path({cal: @calendar.id}), class: "btn btn-primary" %>
</div>
<div class="pull-right">
  <form class="form-inline" style="padding-bottom:1em">
    <div class="field form-group">
      <%= number_field_tag :months, @months, min: 1, max: 36, size: 2, class: 'form-control' %>&nbsp;
      <label class="control-label" for="months">month(s)</label>
    </div>
    <div class="field form-group">
      <label class="control-label" for="startmonth">starting</label>&nbsp;
      <div class="input-group">
        <input value="" class="form-control datepicker" data-date-format="MMMM YYYY" type="text" name="startmonth" id="startmonth" />
        <span class="glyphicon glyphicon-calendar input-group-addon">
      </div>&nbsp;
    </div>
    <input type="submit" value="Show" class="btn btn-primary" />
    <a href="<%= request.path %>" class="btn btn-primary">Reset</a>
  </form>
</div>
<%= javascript_tag do %>
$(function () {
  $('#startmonth').datetimepicker({
    <% if not params[:startmonth].nil? %>
      defaultDate: '<%= j params[:startmonth] %>'
    <% else %>
      defaultDate: '<%= j Date.today.strftime("%Y-%m") %>'
    <% end %>
  });
});
<% end %>

<table class="table table-bordered table-striped">
  <tr>
    <th>Sunday</th>
    <th>Monday</th>
    <th>Tuesday</th>
    <th>Wednesday</th>
    <th>Thursday</th>
    <th>Friday</th>
    <th>Saturday</th>
  </tr>
  <% (0..(5*@months)).each do |week| %>
    <tr>
      <% (0..6).each do |day| %>
        <% thisday = @firstday + day + 7 * week %>
        <td style="width: 14.29%" class="<%= @calendar.appointments.on(thisday).length > 0 ? "success" : "" %>">
          <% if thisday.mday == 1 %>
            <strong><%= link_to thisday.strftime("%B %Y"), new_appointment_path({cal: @calendar.id, startdate: thisday}) %></strong>
          <% else %>
            <div class="pull-right">
              <%= link_to thisday.strftime("%-d"), new_appointment_path({cal: @calendar.id, startdate: thisday}) %>
            </div>
          <% end %>
          <% @calendar.appointments.on(thisday).each do |appointment| %>
            <br /><%= link_to(appointment.person.name, appointment_path(appointment)) %>
          <% end %>          
        </td>  
      <% end %>
    </tr>
  <% end %>
</table>

<h3>Reservation list</h3>
<% if params[:future] == "no" %>
  Showing all reservations. <a href="<%= request.path %>?future=yes">See only current and future reservations</a>
  <% all_appointments = @calendar.appointments.order(:starts) %>
<% else %>
  Showing all current and future reservations. <a href="<%= request.path %>?future=no">See all reservations</a>
  <% all_appointments = @calendar.appointments.after(Date.today).order(:starts) %>
<% end %>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Person</th>
      <th>Dates</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% all_appointments.each do |appointment| %>
      <tr>
        <td><%= link_to appointment.person.name, person_path(appointment.person) %> (<%= link_to appointment.person.group.name, group_path(appointment.person.group) %>)</td>
        <td>
          <%= appointment.starts.strftime("%B %d, %Y") %>
          <% if appointment.starts != appointment.ends %>
            &ndash; <%= appointment.ends.strftime("%B %d, %Y") %>
          <% end %>
        </td>
        <td><%= link_to 'Details', appointment %></td>
        <td>
          <% if appointment.user == current_user || admin? %>
            <%= link_to 'Edit', edit_appointment_path(appointment) %>
          <% end %>
        </td>
        <td>
          <% if appointment.user == current_user || admin? %>
            <%= link_to 'Delete', appointment, method: :delete, data: { confirm: 'Are you sure?' } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
